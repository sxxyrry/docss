import{_ as i,o as a,c as n,ak as l}from"./chunks/framework.CDHwDzB5.js";const E=JSON.parse('{"title":"TT 高速下载器 Node.js/TypeScript 接口封装使用文档","description":"","frontmatter":{},"headers":[],"relativePath":"zh/interface/ts/how-to-use.md","filePath":"zh/interface/ts/how-to-use.md","lastUpdated":1772257285000}'),t={name:"zh/interface/ts/how-to-use.md"};function h(k,s,e,p,r,d){return a(),n("div",null,[...s[0]||(s[0]=[l(`<h1 id="tt-高速下载器-node-js-typescript-接口封装使用文档" tabindex="-1">TT 高速下载器 Node.js/TypeScript 接口封装使用文档 <a class="header-anchor" href="#tt-高速下载器-node-js-typescript-接口封装使用文档" aria-label="Permalink to “TT 高速下载器 Node.js/TypeScript 接口封装使用文档”">​</a></h1><div class="tip custom-block github-alert"><p class="custom-block-title">TIP</p><p>本文档介绍的是 <strong>TTHSD Next</strong>（Rust 版本）的 TypeScript 接口。</p><p>API 接口与 <a href="https://github.com/sxxyrry/TTHighSpeedDownloader" target="_blank" rel="noreferrer">TTHSD Golang</a> 版本完全兼容，只需替换动态库即可迁移。</p><p>TTHSD Golang 已停止开发，建议使用 TTHSD Next 以获得更好的性能。</p></div><p>本文档介绍 <em><strong>TTHSDownloader</strong></em> TypeScript 类，该类为 <strong>TT高速下载器</strong>（<em><strong>tthsd.dll</strong></em>/<em><strong>tthsd.so</strong></em>/<em><strong>tthsd.dylib</strong></em>）提供 Node.js 封装，支持多任务下载的创建、控制与进度回调。该封装以 npm 包 <em><strong>tthsd</strong></em> 形式发布。</p><hr><h2 id="_0-安装说明" tabindex="-1">0. 安装说明 <a class="header-anchor" href="#_0-安装说明" aria-label="Permalink to “0. 安装说明”">​</a></h2><h3 id="_0-1-环境要求" tabindex="-1">0.1 环境要求 <a class="header-anchor" href="#_0-1-环境要求" aria-label="Permalink to “0.1 环境要求”">​</a></h3><ul><li>Node.js 18 及以上版本</li><li>TypeScript 4.0 及以上版本（如使用纯 JavaScript 也可）</li></ul><h3 id="_0-2-安装依赖" tabindex="-1">0.2 安装依赖 <a class="header-anchor" href="#_0-2-安装依赖" aria-label="Permalink to “0.2 安装依赖”">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tthsd</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 或</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yarn</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tthsd</span></span></code></pre></div><p><em><strong>tthsd</strong></em> 已内置所需的 <a href="https://koffi.dev" target="_blank" rel="noreferrer">Koffi</a> 依赖（用于调用动态库），并提供了完整的 TypeScript 类型定义，因此无需单独安装其他 FFI 包。</p><h3 id="_0-3-动态库文件" tabindex="-1">0.3 动态库文件 <a class="header-anchor" href="#_0-3-动态库文件" aria-label="Permalink to “0.3 动态库文件”">​</a></h3><p>将 TT 高速下载器动态库放置在项目可访问的路径：</p><ul><li>Windows 平台：<em><strong>tthsd.dll</strong></em></li><li>macOS 平台：<em><strong>tthsd.dylib</strong></em></li><li>Linux 平台：<em><strong>tthsd.so</strong></em></li></ul><div class="tip custom-block github-alert"><p class="custom-block-title">TIP</p><p>您可以在 <a href="https://github.com/sxxyrry/TTHSDNext/releases/latest" target="_blank" rel="noreferrer">TTHSD Next Releases</a> 页面下载最新版本的动态库文件。</p></div><hr><h2 id="_1-模块概述" tabindex="-1">1. 模块概述 <a class="header-anchor" href="#_1-模块概述" aria-label="Permalink to “1. 模块概述”">​</a></h2><ul><li><strong>核心类</strong>：<em><strong>TTHSDownloader</strong></em>（默认导出）</li><li><strong>便捷函数</strong>：<em><strong>quickDownload</strong></em>（快速开始下载，适合简单场景）</li><li><strong>依赖</strong>：内部使用 <em><strong>Koffi</strong></em> 调用 C 动态库，您无需直接操作它们</li><li><strong>功能</strong>： <ul><li>创建下载器实例（仅创建或立即启动）</li><li>控制下载（开始、暂停、恢复、停止）</li><li>通过回调函数接收下载进度、事件通知（<em><strong>update</strong></em>、<em><strong>endOne</strong></em>、<em><strong>end</strong></em>、<em><strong>msg</strong></em>、<em><strong>err</strong></em> 等）</li></ul></li></ul><hr><h2 id="_2-tthsdownloader-类" tabindex="-1">2. <em><strong>TTHSDownloader</strong></em> 类 <a class="header-anchor" href="#_2-tthsdownloader-类" aria-label="Permalink to “2. TTHSDownloader 类”">​</a></h2><h3 id="_2-1-构造函数" tabindex="-1">2.1 构造函数 <a class="header-anchor" href="#_2-1-构造函数" aria-label="Permalink to “2.1 构造函数”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">constructor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(options</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { dllPath?: string })</span></span></code></pre></div><ul><li><strong>参数</strong> <em><strong>options.dllPath</strong></em>：动态库路径（可选）。若不提供，自动在以下目录搜索（优先级从高到低）： <ol><li>Electron 的 <em><strong>resources/app.asar.unpacked/</strong></em> 目录（适用于 Electron 打包场景）</li><li>可执行文件（<em><strong>process.execPath</strong></em>）所在目录</li><li>当前工作目录（<em><strong>process.cwd()</strong></em>）</li><li><em><strong>__dirname</strong></em> 及上级目录</li></ol></li></ul><h3 id="_2-2-创建下载器" tabindex="-1">2.2 创建下载器 <a class="header-anchor" href="#_2-2-创建下载器" aria-label="Permalink to “2.2 创建下载器”">​</a></h3><h4 id="getdownloader-number" tabindex="-1"><em><strong>getDownloader(...) =&gt; number</strong></em> <a class="header-anchor" href="#getdownloader-number" aria-label="Permalink to “getDownloader(...) =&gt; number”">​</a></h4><p>仅创建下载器（不启动），返回实例 ID。</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getDownloader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    urls: string[],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    savePaths: string[],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    options</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        threadCount?: number;       </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 默认 64</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        chunkSizeMB</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> number;       </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 默认 10</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        callback</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DownloadCallback; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 进度回调</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        userAgent</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string;         </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 自定义 UA（不填使用 DLL 内置值）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        useCallbackUrl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> boolean;   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 是否启用远程回调 URL</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        remoteCallbackUrl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 远程回调地址</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        useSocket</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> boolean;        </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 是否使用 Socket（与 WebSocket 二选一）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        showNames</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string[];       </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 各任务显示名称覆盖</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ids</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string[];             </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 各任务 ID 覆盖（不填自动生成 UUID）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">): number</span></span></code></pre></div><ul><li><strong>返回</strong>：下载器实例 ID（正整数），若 DLL 返回 -1 则抛出异常。</li></ul><h4 id="startdownload-number" tabindex="-1"><em><strong>startDownload(...) =&gt; number</strong></em> <a class="header-anchor" href="#startdownload-number" aria-label="Permalink to “startDownload(...) =&gt; number”">​</a></h4><p>创建并<strong>立即启动</strong>下载，参数与 <em><strong>getDownloader</strong></em> 基本相同，额外支持：</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">startDownload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    urls: string[],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    savePaths: string[],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    options</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ... 同 getDownloader 的 options</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        isMultiple?: boolean;       </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 是否并行下载（默认 false 顺序下载）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">): number</span></span></code></pre></div><ul><li><strong>返回</strong>：下载器实例 ID（正整数），若 DLL 返回 -1 则抛出异常。</li></ul><h3 id="_2-3-控制下载" tabindex="-1">2.3 控制下载 <a class="header-anchor" href="#_2-3-控制下载" aria-label="Permalink to “2.3 控制下载”">​</a></h3><p>所有控制方法均返回 <em><strong>boolean</strong></em>，<em><strong>true</strong></em> 表示操作成功（DLL 返回 0），<em><strong>false</strong></em> 表示失败（如 ID 不存在）。</p><ul><li><em><strong>startDownloadById(downloaderId: number): boolean</strong></em>：开始顺序下载（配合 <em><strong>getDownloader</strong></em> 使用）</li><li><em><strong>startMultipleDownloadsById(downloaderId: number): boolean</strong></em>：开始并行下载（实验性）</li><li><em><strong>pauseDownload(downloaderId: number): boolean</strong></em>：暂停下载</li><li><em><strong>resumeDownload(downloaderId: number): boolean</strong></em>：恢复下载</li><li><em><strong>stopDownload(downloaderId: number): boolean</strong></em>：停止下载并销毁下载器实例（无法恢复）</li><li><em><strong>dispose(): void</strong></em>：释放实例持有的所有资源（回调引用等），通常在程序退出前调用。</li></ul><hr><h2 id="_3-便捷函数-quickdownload" tabindex="-1">3. 便捷函数 <em><strong>quickDownload</strong></em> <a class="header-anchor" href="#_3-便捷函数-quickdownload" aria-label="Permalink to “3. 便捷函数 quickDownload”">​</a></h2><p>对于简单的单次下载任务，可以直接使用 <em><strong>quickDownload</strong></em> 函数，它会自动创建下载器、启动下载并返回 Promise（等待下载完成）。</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { quickDownload } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;tthsd&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">quickDownload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  urls: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://example.com/file1.zip&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  savePaths: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;./downloads/file1.zip&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  callback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (event.Type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;update&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">***</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">进度: \${data.Downloaded}</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\${data.Total}</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">***</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  threadCount: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  chunkSizeMB: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><p>函数签名：</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> quickDownload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">options</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    urls</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[];</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    savePaths</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[];</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    threadCount</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    chunkSizeMB</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    callback</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DownloadCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    userAgent</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    useCallbackUrl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    remoteCallbackUrl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    useSocket</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    isMultiple</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 是否并行下载</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    dllPath</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 动态库路径（可选）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span></code></pre></div><blockquote><p><strong>注意</strong>：<em><strong>quickDownload</strong></em> 返回一个 <em><strong>Promise</strong></em>，当所有下载任务完成或发生错误时 resolve/reject。因此它适合在 async 函数中配合 <em><strong>await</strong></em> 使用。</p></blockquote><hr><h2 id="_4-回调函数" tabindex="-1">4. 回调函数 <a class="header-anchor" href="#_4-回调函数" aria-label="Permalink to “4. 回调函数”">​</a></h2><h3 id="_4-1-定义格式" tabindex="-1">4.1 定义格式 <a class="header-anchor" href="#_4-1-定义格式" aria-label="Permalink to “4.1 定义格式”">​</a></h3><p>用户提供的回调函数需接受两个参数：</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DownloadCallback</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">event</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DownloadEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CallbackData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><ul><li><strong>event</strong>：包含事件类型、名称等元数据<div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DownloadEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  Type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> EventType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// &quot;start&quot; | &quot;startOne&quot; | &quot;update&quot; | &quot;endOne&quot; | &quot;end&quot; | &quot;msg&quot; | &quot;err&quot;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  Name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;         </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 事件名称（如“开始下载”）</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  ShowName</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;     </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 任务显示名称</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  ID</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;           </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 任务 ID</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li><li><strong>data</strong>：携带具体数据（类型根据 event.Type 变化）</li></ul><h3 id="_4-2-事件类型与数据格式" tabindex="-1">4.2 事件类型与数据格式 <a class="header-anchor" href="#_4-2-事件类型与数据格式" aria-label="Permalink to “4.2 事件类型与数据格式”">​</a></h3><p>本部分与 <a href="/TTHSD/zh/event/event-overview.html">Event 文档</a> 相同，在此不过多赘述。</p><h3 id="_4-3-线程安全要求" tabindex="-1">4.3 线程安全要求 <a class="header-anchor" href="#_4-3-线程安全要求" aria-label="Permalink to “4.3 线程安全要求”">​</a></h3><ul><li>回调函数在 <strong>DLL 内部的工作线程</strong> 中执行，但在 Node.js 中会被包装后进入事件循环，因此不会阻塞其他操作。</li><li><strong>禁止在回调中执行耗时操作</strong>（如磁盘写入、网络请求），也<strong>禁止直接进行可能阻塞事件循环的操作</strong>。</li><li>如果多个下载器共享同一个回调，需自行加锁保护共享数据（Node.js 是单线程，但回调可能交错，可使用原子操作或队列）。</li></ul><hr><h2 id="_5-使用示例" tabindex="-1">5. 使用示例 <a class="header-anchor" href="#_5-使用示例" aria-label="Permalink to “5. 使用示例”">​</a></h2><h3 id="_5-1-基本用法-创建后手动启动" tabindex="-1">5.1 基本用法（创建后手动启动） <a class="header-anchor" href="#_5-1-基本用法-创建后手动启动" aria-label="Permalink to “5.1 基本用法（创建后手动启动）”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { TTHSDownloader } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;tthsd&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> onProgress</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">event</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">msg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (event.Type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;update&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> total</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> msg.Total;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> downloaded</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> msg.Downloaded;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> taskId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> event.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (total) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">***</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">进度 [\${taskId}]: \${(downloaded / total * </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).toFixed(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)}</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%***</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (event.Type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;startOne&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> url</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> msg.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">URL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> taskId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> event.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">***</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">开始下载: \${url} (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ID</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">taskId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})***);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } else if (event.Type === </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;endOne&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        const url </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> msg.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">URL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        const taskId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> event.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        console.log(***下载完成: \${url} (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ID</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">taskId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})***);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } else if (event.Type === </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;err&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        console.error(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;错误:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, msg.Error);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">const downloader </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TTHSDownloader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 自动搜索动态库</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">const id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> downloader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getDownloader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;https://example.com/file1.zip&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;https://example.com/file2.zip&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;./downloads/file1.zip&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;./downloads/file2.zip&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        threadCount: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        chunkSizeMB: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        callback: onProgress</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    downloader.startDownloadById(id);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 稍后可以暂停、恢复等</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // downloader.pauseDownload(id);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_5-2-创建后手动启动-并行下载" tabindex="-1">5.2 创建后手动启动（并行下载） <a class="header-anchor" href="#_5-2-创建后手动启动-并行下载" aria-label="Permalink to “5.2 创建后手动启动（并行下载）”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { TTHSDownloader } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;tthsd&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> downloader</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TTHSDownloader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ dllPath: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;./custom/path/libtthsd.so&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> downloader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getDownloader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;https://example.com/bigfile.iso&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;./downloads/bigfile.iso&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        threadCount: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        chunkSizeMB: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        callback: onProgress</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    downloader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">startMultipleDownloadsById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(id);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_5-3-使用内置事件日志器" tabindex="-1">5.3 使用内置事件日志器 <a class="header-anchor" href="#_5-3-使用内置事件日志器" aria-label="Permalink to “5.3 使用内置事件日志器”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { TTHSDownloader, EventLogger } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;tthsd&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> logger</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> EventLogger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 内置的控制台打印器</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> downloader</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TTHSDownloader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> downloader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">startDownload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;https://example.com/file.zip&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;./downloads/file.zip&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    { callback: logger.callback }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><hr><h2 id="_6-内存管理" tabindex="-1">6. 内存管理 <a class="header-anchor" href="#_6-内存管理" aria-label="Permalink to “6. 内存管理”">​</a></h2><h3 id="_6-1-回调函数引用管理" tabindex="-1">6.1 回调函数引用管理 <a class="header-anchor" href="#_6-1-回调函数引用管理" aria-label="Permalink to “6.1 回调函数引用管理”">​</a></h3><p>每次调用 <em><strong>getDownloader</strong></em> 或 <em><strong>startDownload</strong></em> 时，若提供了回调函数，会通过 <em><strong>Koffi</strong></em> 创建一个 C 可调用对象。该对象必须保持存活，否则 C 代码调用时会崩溃。</p><p>TypeScript 接口通过以下方式管理这些引用：</p><ul><li>回调对象被保存在内部 Map 中（键为下载器 ID）</li><li>调用 <em><strong>stopDownload</strong></em> 时会自动取消注册对应的回调引用</li><li>调用 <em><strong>dispose()</strong></em> 会释放所有引用</li><li>垃圾回收器不会自动回收这些引用（因为 C 代码持有它们），因此必须显式调用 <em><strong>stopDownload</strong></em> 或 <em><strong>dispose</strong></em> 来避免内存泄漏。</li></ul><p><strong>最佳实践</strong>：在下载完成后调用 <em><strong>stopDownload</strong></em> 释放资源，或在程序退出前调用 <em><strong>dispose()</strong></em>。</p><hr><h2 id="_7-注意事项" tabindex="-1">7. 注意事项 <a class="header-anchor" href="#_7-注意事项" aria-label="Permalink to “7. 注意事项”">​</a></h2><ol><li><strong>DLL 路径</strong>：若自动搜索失败，需显式传入正确路径。动态库必须与 Node.js 进程架构（32/64 位）匹配。</li><li><strong>任务数据一致性</strong>：<em><strong>urls</strong></em> 与 <em><strong>savePaths</strong></em> 长度必须相等。</li><li><strong>ID 有效性</strong>：所有控制方法（<em><strong>pauseDownload</strong></em> 等）在 ID 不存在时返回 <em><strong>false</strong></em>，不会抛出异常。</li><li><strong>回调异常</strong>：回调中若抛出异常，会被模块捕获并输出到控制台（<em><strong>console.error</strong></em>），但不会中断下载流程。</li><li><strong>多线程环境</strong>：Node.js 是单线程事件循环，但回调可能来自不同线程，不过经过 Koffi 处理后它们会被调度到事件循环中，因此无需额外加锁。但要注意不要在回调中执行同步耗时操作。</li><li><strong>Node.js 版本</strong>：Koffi 需要 Node.js 18 或更高版本，建议使用 LTS 版本。</li></ol><hr><h2 id="_8-tthsd-next-的优势" tabindex="-1">8. TTHSD Next 的优势 <a class="header-anchor" href="#_8-tthsd-next-的优势" aria-label="Permalink to “8. TTHSD Next 的优势”">​</a></h2><p>相比 TTHSD Golang 版本，使用 TTHSD Next 的 TypeScript 接口可以获得以下优势：</p><h3 id="性能提升" tabindex="-1">性能提升 <a class="header-anchor" href="#性能提升" aria-label="Permalink to “性能提升”">​</a></h3><ul><li><strong>更高的下载速度</strong>：优化的异步 I/O 模型</li><li><strong>更低的内存占用</strong>：精细的内存管理，无 GC 开销</li><li><strong>更高的并发数</strong>：可支持数十万并发连接</li><li><strong>更稳定的性能</strong>：无 GC 暂停，性能可预测</li></ul><h3 id="兼容性" tabindex="-1">兼容性 <a class="header-anchor" href="#兼容性" aria-label="Permalink to “兼容性”">​</a></h3><ul><li><strong>完全兼容</strong>：API 接口与 TTHSD Golang 版本完全兼容</li><li><strong>直接替换</strong>：只需替换动态库文件即可迁移</li><li><strong>代码无需修改</strong>：现有代码可以直接使用</li></ul><hr><h2 id="_9-常见问题" tabindex="-1">9. 常见问题 <a class="header-anchor" href="#_9-常见问题" aria-label="Permalink to “9. 常见问题”">​</a></h2><p><strong>Q: 为什么我的回调没有收到 <em><strong>update</strong></em> 事件？</strong><br> A: 检查 <em><strong>callback</strong></em> 参数是否传入，且您的回调处理正常。也可通过 <em><strong>EventLogger</strong></em> 观察是否有回调异常。</p><p><strong>Q: 需要手动释放资源或调用 close() 吗？</strong><br> A: 建议在下载完成后调用 <em><strong>stopDownload</strong></em> 释放对应 ID 的资源。如果不再使用整个实例，可调用 <em><strong>dispose()</strong></em>。但实例被垃圾回收时也会尝试释放，不过不保证及时。</p><p><strong>Q: 需要并发下载多个任务组怎么办？</strong><br> A: 创建多个 <em><strong>TTHSDownloader</strong></em> 实例，每个管理一组任务。它们独立运行。或配合 <em><strong>worker_threads</strong></em> 模块执行多次开始下载。</p><p><strong>Q: TTHSD Next 与 TTHSD Golang 有什么区别？</strong><br> A: TTHSD Next 是 TTHSD Golang 的 Rust 重写版本，具有更高的性能、更低的内存占用和更稳定的运行表现。API 接口完全兼容，只需替换动态库即可迁移。</p><p><strong>Q: 我可以从 TTHSD Golang 迁移到 TTHSD Next 吗？</strong><br> A: 是的，API 接口完全兼容，只需将动态库文件从 TTHighSpeedDownloader.dll/so/dylib 替换为 tthsd.dll/so/dylib 即可，代码无需修改。</p><p><strong>Q: 安装 <em><strong>tthsd</strong></em> 后还需要单独安装 <em><strong>koffi</strong></em> 吗？</strong><br> A: 不需要。<em><strong>tthsd</strong></em> 已将其作为依赖包含，您只需安装这一个包即可。</p><p><strong>Q: 如何自定义任务 ID 和显示名称？</strong><br> A: 在 <em><strong>getDownloader</strong></em> 或 <em><strong>startDownload</strong></em> 的 options 中传入 <em><strong>ids</strong></em> 和 <em><strong>showNames</strong></em> 数组，长度需与 urls 一致。</p><p><strong>Q: 为什么 <em><strong>getDownloader</strong></em> 返回的 ID 是负数？</strong><br> A: 正常情况不会返回负数；若返回 -1 会抛出异常。如果看到负数，可能是 DLL 加载失败或参数错误。</p><hr><p>如有问题，请参考 <a href="https://github.com/sxxyrry/TTHSDNext" target="_blank" rel="noreferrer">TTHSD Next GitHub</a> 、 <a href="https://github.com/sxxyrry/tthsd-interface-ts" target="_blank" rel="noreferrer">tthsd-interface (TypeScript) GitHub </a> 或 <a href="/TTHSD/zh/api/API-overview.html">API 文档</a>。</p>`,88)])])}const o=i(t,[["render",h]]);export{E as __pageData,o as default};
