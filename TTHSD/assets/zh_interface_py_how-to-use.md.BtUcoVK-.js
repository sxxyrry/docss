import{_ as i,o as a,c as n,ak as t}from"./chunks/framework.CDHwDzB5.js";const E=JSON.parse('{"title":"TT 高速下载器 Python 接口封装使用文档","description":"","frontmatter":{},"headers":[],"relativePath":"zh/interface/py/how-to-use.md","filePath":"zh/interface/py/how-to-use.md","lastUpdated":1772257285000}'),h={name:"zh/interface/py/how-to-use.md"};function l(k,s,e,p,r,d){return a(),n("div",null,[...s[0]||(s[0]=[t(`<h1 id="tt-高速下载器-python-接口封装使用文档" tabindex="-1">TT 高速下载器 Python 接口封装使用文档 <a class="header-anchor" href="#tt-高速下载器-python-接口封装使用文档" aria-label="Permalink to “TT 高速下载器 Python 接口封装使用文档”">​</a></h1><div class="tip custom-block github-alert"><p class="custom-block-title">TIP</p><p>本文档介绍的是 <strong>TTHSD Next</strong>（Rust 版本）的 Python 接口。</p><p>API 接口与 <a href="https://github.com/sxxyrry/TTHighSpeedDownloader" target="_blank" rel="noreferrer">TTHSD Golang</a> 版本完全兼容，只需替换动态库即可迁移。</p><p>TTHSD Golang 已停止开发，建议使用 TTHSD Next 以获得更好的性能。</p></div><p>本文档介绍 <em><strong>TTHSD_interface.py</strong></em> 模块，该模块为 <strong>TT高速下载器</strong>（<em><strong>TTHSD.dll</strong></em>/<em><strong>.so</strong></em>/<em><strong>.dylib</strong></em>）提供 Python 封装，支持多任务下载的创建、控制与进度回调。</p><hr><h2 id="_0-安装说明" tabindex="-1">0. 安装说明 <a class="header-anchor" href="#_0-安装说明" aria-label="Permalink to “0. 安装说明”">​</a></h2><h3 id="_0-1-安装依赖" tabindex="-1">0.1 安装依赖 <a class="header-anchor" href="#_0-1-安装依赖" aria-label="Permalink to “0.1 安装依赖”">​</a></h3><ol><li>Python 3.11 及以上版本</li><li>TT高速下载器动态库文件： <ul><li>Windows 平台：<em><strong>TTHSD.dll</strong></em></li><li>macOS 平台：<em><strong>TTHSD.dylib</strong></em></li><li>Linux 平台：<em><strong>TTHSD.so</strong></em></li></ul></li></ol><h3 id="_0-2-安装步骤" tabindex="-1">0.2 安装步骤 <a class="header-anchor" href="#_0-2-安装步骤" aria-label="Permalink to “0.2 安装步骤”">​</a></h3><ol><li>将动态库文件放置在项目目录中</li><li>将 <em><strong>TTHSD_interface.py</strong></em> 复制到项目目录</li></ol><hr><h2 id="_1-模块概述" tabindex="-1">1. 模块概述 <a class="header-anchor" href="#_1-模块概述" aria-label="Permalink to “1. 模块概述”">​</a></h2><ul><li><strong>核心类</strong>：<em><strong>TTHSDownloader</strong></em></li><li><strong>依赖</strong>：<em><strong>ctypes</strong></em>、<em><strong>json</strong></em>、<em><strong>threading</strong></em>、<em><strong>queue</strong></em>、<em><strong>weakref</strong></em> 等标准库</li><li><strong>功能</strong>： <ul><li>创建下载器实例（立即启动或只创建）</li><li>控制下载（开始、暂停、恢复、停止）</li><li>通过回调函数接收下载进度、事件通知（<em><strong>update</strong></em>、<em><strong>endOne</strong></em>、<em><strong>end</strong></em>、<em><strong>msg</strong></em>、<em><strong>err</strong></em> 等）</li><li>内置线程安全、异步日志记录</li></ul></li></ul><hr><h2 id="_2-tthsdownloader-类" tabindex="-1">2. <em><strong>TTHSDownloader</strong></em> 类 <a class="header-anchor" href="#_2-tthsdownloader-类" aria-label="Permalink to “2. TTHSDownloader 类”">​</a></h2><h3 id="_2-1-初始化" tabindex="-1">2.1 初始化 <a class="header-anchor" href="#_2-1-初始化" aria-label="Permalink to “2.1 初始化”">​</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">downloader </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TTHSDownloader(dll_path: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pathlib.Path </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> None</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><ul><li><strong>参数</strong> <em><strong>dll_path</strong></em>：动态库路径。若为 <em><strong>None</strong></em>，根据操作系统自动猜测默认文件名（Windows: <em><strong>TTHSD.dll</strong></em>，macOS: <em><strong>TTHSD.dylib</strong></em>，Linux: <em><strong>TTHSD.so</strong></em>），路径为当前工作目录。</li></ul><h3 id="_2-2-创建下载器" tabindex="-1">2.2 创建下载器 <a class="header-anchor" href="#_2-2-创建下载器" aria-label="Permalink to “2.2 创建下载器”">​</a></h3><h4 id="start-download-int" tabindex="-1"><em><strong>start_download(...) -&gt; int</strong></em> <a class="header-anchor" href="#start-download-int" aria-label="Permalink to “start_download(...) -&gt; int”">​</a></h4><p>立即创建并启动下载器。</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> start_download</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    urls: list[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    save_paths: list[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    thread_count: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    chunk_size_mb: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    callback: Callable[[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">dict</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">dict</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    use_callback_url: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">bool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    user_agent: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    remote_callback_url: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    use_socket: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">bool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    is_multiple: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">bool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">int</span></span></code></pre></div><ul><li><strong>返回</strong>：下载器实例 ID（正整数），失败时返回 -1。</li></ul><h4 id="get-downloader-int" tabindex="-1"><em><strong>get_downloader(...) -&gt; int</strong></em> <a class="header-anchor" href="#get-downloader-int" aria-label="Permalink to “get_downloader(...) -&gt; int”">​</a></h4><p>仅创建下载器（不启动），返回实例 ID。参数同 <em><strong>start_download</strong></em>（不含 <em><strong>is_multiple</strong></em>）。</p><h3 id="_2-3-控制下载" tabindex="-1">2.3 控制下载 <a class="header-anchor" href="#_2-3-控制下载" aria-label="Permalink to “2.3 控制下载”">​</a></h3><p>所有控制方法均返回 <em><strong>bool</strong></em>，<em><strong>True</strong></em> 表示操作成功（DLL 返回 0），<em><strong>False</strong></em> 表示失败（如 ID 不存在）。</p><ul><li><em><strong>start_download_by_id(downloader_id: int) -&gt; bool</strong></em>：开始顺序下载</li><li><em><strong>start_multiple_downloads_by_id(downloader_id: int) -&gt; bool</strong></em>：开始并行下载（实验性）</li><li><em><strong>pause_download(downloader_id: int) -&gt; bool</strong></em>：暂停下载</li><li><em><strong>resume_download(downloader_id: int) -&gt; bool</strong></em>：恢复下载</li><li><em><strong>stop_download(downloader_id: int) -&gt; bool</strong></em>：停止下载</li></ul><h3 id="_2-4-资源管理" tabindex="-1">2.4 资源管理 <a class="header-anchor" href="#_2-4-资源管理" aria-label="Permalink to “2.4 资源管理”">​</a></h3><p>Python 接口会自动管理回调函数引用，无需手动清理资源。当下载器实例被销毁时，相关引用会被自动释放。</p><h4 id="上下文管理器支持" tabindex="-1">上下文管理器支持 <a class="header-anchor" href="#上下文管理器支持" aria-label="Permalink to “上下文管理器支持”">​</a></h4><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TTHSDownloader() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> d:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    d.start_download(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 退出 with 块时自动清理资源</span></span></code></pre></div><p>注意：当前实现不支持显式的 <em><strong>close()</strong></em> 方法，资源由 Python 垃圾回收机制自动管理。</p><hr><h2 id="_3-回调函数" tabindex="-1">3. 回调函数 <a class="header-anchor" href="#_3-回调函数" aria-label="Permalink to “3. 回调函数”">​</a></h2><h3 id="_3-1-定义格式" tabindex="-1">3.1 定义格式 <a class="header-anchor" href="#_3-1-定义格式" aria-label="Permalink to “3.1 定义格式”">​</a></h3><p>用户提供的回调函数需接受两个字典参数：</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> my_callback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(event: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">dict</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, msg: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">dict</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    ...</span></span></code></pre></div><ul><li><strong>event</strong>：包含事件类型、名称等元数据</li><li><strong>msg</strong>：携带具体数据（进度、结果、错误等）</li></ul><h3 id="_3-2-事件类型与数据格式" tabindex="-1">3.2 事件类型与数据格式 <a class="header-anchor" href="#_3-2-事件类型与数据格式" aria-label="Permalink to “3.2 事件类型与数据格式”">​</a></h3><p>本部分与 <a href="/TTHSD/zh/event/event-overview.html">Event 文档</a> 相同，在此不过多赘述。</p><h3 id="_3-3-线程安全要求" tabindex="-1">3.3 线程安全要求 <a class="header-anchor" href="#_3-3-线程安全要求" aria-label="Permalink to “3.3 线程安全要求”">​</a></h3><ul><li>回调函数在 <strong>DLL 内部的工作线程</strong> 中执行。</li><li><strong>禁止在回调中执行耗时操作</strong>（如磁盘写入、网络请求），也<strong>禁止直接更新 GUI</strong>（应通过队列发送到主线程）。</li><li>如果多个下载器共享同一个回调，需自行加锁保护共享数据。</li></ul><hr><h2 id="_4-使用示例" tabindex="-1">4. 使用示例 <a class="header-anchor" href="#_4-使用示例" aria-label="Permalink to “4. 使用示例”">​</a></h2><h3 id="_4-1-基本用法-立即启动" tabindex="-1">4.1 基本用法（立即启动） <a class="header-anchor" href="#_4-1-基本用法-立即启动" aria-label="Permalink to “4.1 基本用法（立即启动）”">​</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> TTHSD_interface</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TTHSDownloader</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> on_progress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(event, msg):</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> event[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Type&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;update&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> msg.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Total&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        downloaded </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> msg.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Downloaded&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        task_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> event.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ID&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ID 从 event 获取</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> total:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;进度 [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">task_id</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">]: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">downloaded</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">total</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:.1%</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    elif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> event[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Type&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;startOne&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        url </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> msg.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;URL&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        task_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> event.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ID&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ID 从 event 获取</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        index </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> msg.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Index&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> msg.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Total&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;开始下载 [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">index</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">total</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">]: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">url</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> (ID: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">task_id</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    elif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> event[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Type&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;endOne&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        url </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> msg.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;URL&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        task_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> event.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ID&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ID 从 event 获取</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;下载完成: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">url</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> (ID: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">task_id</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    elif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> event[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Type&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;err&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;错误:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, msg.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Error&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 剩下的处理可以去查看 示例/TTHSD Python 接口封装 的 Callback 示例</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TTHSDownloader() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dl:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    dl_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dl.start_download(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        urls</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://example.com/file1.zip&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://example.com/file2.zip&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        save_paths</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;./downloads/file1.zip&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;./downloads/file2.zip&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        thread_count</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        callback</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">on_progress</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    )</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 程序退出 with 块时自动 close()</span></span></code></pre></div><h3 id="_4-2-创建后手动启动-并行下载" tabindex="-1">4.2 创建后手动启动（并行下载） <a class="header-anchor" href="#_4-2-创建后手动启动-并行下载" aria-label="Permalink to “4.2 创建后手动启动（并行下载）”">​</a></h3><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TTHSDownloader()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dl_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dl.get_downloader(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    urls</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://example.com/bigfile.iso&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    save_paths</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;./downloads/bigfile.iso&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    thread_count</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dl.start_multiple_downloads_by_id(dl_id)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ... 后续可暂停、恢复等</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 资源会在 dl 对象被销毁时自动清理</span></span></code></pre></div><hr><h2 id="_5-内存管理" tabindex="-1">5. 内存管理 <a class="header-anchor" href="#_5-内存管理" aria-label="Permalink to “5. 内存管理”">​</a></h2><h3 id="_5-1-回调函数引用管理" tabindex="-1">5.1 回调函数引用管理 <a class="header-anchor" href="#_5-1-回调函数引用管理" aria-label="Permalink to “5.1 回调函数引用管理”">​</a></h3><p>每次调用 <em><strong>start_download</strong></em> 或 <em><strong>get_downloader</strong></em> 时，若提供了回调函数，会通过 <em><strong>ctypes.CFUNCTYPE</strong></em> 创建一个 C 可调用对象。该对象必须保持存活，否则 C 代码调用时会崩溃。</p><p>Python 接口通过以下方式管理这些引用：</p><ul><li>回调对象被保存在 <em><strong>self._callback_refs</strong></em> 字典中，以回调对象的 id 为键</li><li>这些引用会随着 <em><strong>TTHSDownloader</strong></em> 实例一起被 Python 垃圾回收器自动清理</li><li>无需手动干预或调用额外的清理方法</li></ul><hr><h2 id="_6-日志系统-内部" tabindex="-1">6. 日志系统（内部） <a class="header-anchor" href="#_6-日志系统-内部" aria-label="Permalink to “6. 日志系统（内部）”">​</a></h2><p>模块内置了异步、线程安全的日志器 <em><strong>_TIlog</strong></em>，日志默认：</p><ul><li>输出到控制台</li><li>写入文件 <em><strong>TTHSDPyInter.log</strong></em>（位于可执行文件目录或当前目录）</li><li>日志级别：<em><strong>INFO</strong></em></li></ul><p>可通过修改 <em><strong>_TIlog</strong></em> 的配置（不推荐，仅供调试）调整。日志文件采用 <em><strong>&#39;cf&#39;</strong></em> 模式（自动创建文件）。</p><p><strong>注意</strong>：当前实现不包含 atexit 清理机制，日志会在程序正常退出时完成写入。</p><hr><h2 id="_7-注意事项" tabindex="-1">7. 注意事项 <a class="header-anchor" href="#_7-注意事项" aria-label="Permalink to “7. 注意事项”">​</a></h2><ol><li><strong>DLL 路径</strong>：若自动猜测失败，需显式传入正确路径。</li><li><strong>任务数据一致性</strong>：<em><strong>urls</strong></em> 与 <em><strong>save_paths</strong></em> 长度必须相等。</li><li><strong>ID 有效性</strong>：所有控制方法（<em><strong>pause</strong></em> 等）在 ID 不存在时返回 <em><strong>False</strong></em>，不会抛出异常。</li><li><strong>回调异常</strong>：回调中若抛出异常，会被模块捕获并记录到日志，但不会中断下载流程。</li><li><strong>多线程环境</strong>：不同线程使用不同的 <em><strong>TTHSDownloader</strong></em> 实例是安全的。同一实例的方法（除回调注册外）在 Python 层面未加锁，但 DLL 内部状态由自身管理。</li></ol><hr><h2 id="_8-tthsd-next-的优势" tabindex="-1">8. TTHSD Next 的优势 <a class="header-anchor" href="#_8-tthsd-next-的优势" aria-label="Permalink to “8. TTHSD Next 的优势”">​</a></h2><p>相比 TTHSD Golang 版本，使用 TTHSD Next 的 Python 接口可以获得以下优势：</p><h3 id="性能提升" tabindex="-1">性能提升 <a class="header-anchor" href="#性能提升" aria-label="Permalink to “性能提升”">​</a></h3><ul><li><strong>更高的下载速度</strong>：优化的异步 I/O 模型</li><li><strong>更低的内存占用</strong>：精细的内存管理，无 GC 开销</li><li><strong>更高的并发数</strong>：可支持数十万并发连接</li><li><strong>更稳定的性能</strong>：无 GC 暂停，性能可预测</li></ul><h3 id="兼容性" tabindex="-1">兼容性 <a class="header-anchor" href="#兼容性" aria-label="Permalink to “兼容性”">​</a></h3><ul><li><strong>完全兼容</strong>：API 接口与 TTHSD Golang 版本完全兼容</li><li><strong>直接替换</strong>：只需替换动态库文件即可迁移</li><li><strong>代码无需修改</strong>：现有代码可以直接使用</li></ul><hr><h2 id="_9-常见问题" tabindex="-1">9. 常见问题 <a class="header-anchor" href="#_9-常见问题" aria-label="Permalink to “9. 常见问题”">​</a></h2><p><strong>Q: 为什么我的回调没有收到 <em><strong>update</strong></em> 事件？</strong><br> A: 检查 <em><strong>callback</strong></em> 参数是否传入，且您的回调处理正常。也可通过日志观察是否有回调异常。</p><p><strong>Q: 一定需要手动调用 close() 方法吗？</strong><br> A: 可以不需要。当前实现会自动管理资源，无需手动调用 close() 方法。Python 的垃圾回收机制会自动清理相关引用，但是如果想要调用也可以调用。</p><p><strong>Q: 需要并发下载多个任务组怎么办？</strong><br> A: 创建多个 <em><strong>TTHSDownloader</strong></em> 实例，每个管理一组任务。它们独立运行。或配合 <em><strong>threading</strong></em> 模块执行多次 开始下载</p><p><strong>Q: TTHSD Next 与 TTHSD Golang 有什么区别？</strong><br> A: TTHSD Next 是 TTHSD Golang 的 Rust 重写版本，具有更高的性能、更低的内存占用和更稳定的运行表现。API 接口完全兼容，只需替换动态库即可迁移。</p><p><strong>Q: 我可以从 TTHSD Golang 迁移到 TTHSD Next 吗？</strong><br> A: 是的，API 接口完全兼容，只需将动态库文件从 TTHighSpeedDownloader.dll/so/dylib 替换为 TTHSD.dll/so/dylib 即可，代码无需修改。</p><hr><p>如有问题，请参考 <a href="https://github.com/sxxyrry/TTHSDNext" target="_blank" rel="noreferrer">TTHSD Next GitHub</a> 或提交 issue。</p>`,79)])])}const o=i(h,[["render",l]]);export{E as __pageData,o as default};
