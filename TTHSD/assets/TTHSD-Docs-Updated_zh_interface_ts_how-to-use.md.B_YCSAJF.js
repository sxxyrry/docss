import{_ as i,o as a,c as n,ak as l}from"./chunks/framework.CDHwDzB5.js";const o=JSON.parse('{"title":"TT 高速下载器 Node.js/TypeScript 接口封装使用文档","description":"","frontmatter":{},"headers":[],"relativePath":"TTHSD-Docs-Updated/zh/interface/ts/how-to-use.md","filePath":"TTHSD-Docs-Updated/zh/interface/ts/how-to-use.md","lastUpdated":1772257285000}'),t={name:"TTHSD-Docs-Updated/zh/interface/ts/how-to-use.md"};function h(e,s,k,r,p,d){return a(),n("div",null,[...s[0]||(s[0]=[l(`<h1 id="tt-高速下载器-node-js-typescript-接口封装使用文档" tabindex="-1">TT 高速下载器 Node.js/TypeScript 接口封装使用文档 <a class="header-anchor" href="#tt-高速下载器-node-js-typescript-接口封装使用文档" aria-label="Permalink to “TT 高速下载器 Node.js/TypeScript 接口封装使用文档”">​</a></h1><div class="tip custom-block github-alert"><p class="custom-block-title">TIP</p><p>本文档介绍的是 <strong>TTHSD Next</strong>（Rust 版本）的 TypeScript 接口。</p><p>API 接口与 <a href="https://github.com/sxxyrry/TTHighSpeedDownloader" target="_blank" rel="noreferrer">TTHSD Golang</a> 版本完全兼容，只需替换动态库即可迁移。</p><p>TTHSD Golang 已停止开发，建议使用 TTHSD Next 以获得更好的性能。</p></div><p>本文档介绍 <em><strong>TTHSDownloader</strong></em> TypeScript 类，该类为 <strong>TT高速下载器</strong>（<em><strong>TTHSD.dll</strong></em>/<em><strong>.so</strong></em>/<em><strong>.dylib</strong></em>）提供 Node.js 封装，支持多任务下载的创建、控制与进度回调。该封装以 npm 包 <em><strong>tthsd-interface</strong></em> 形式发布。</p><hr><h2 id="_0-安装说明" tabindex="-1">0. 安装说明 <a class="header-anchor" href="#_0-安装说明" aria-label="Permalink to “0. 安装说明”">​</a></h2><h3 id="_0-1-环境要求" tabindex="-1">0.1 环境要求 <a class="header-anchor" href="#_0-1-环境要求" aria-label="Permalink to “0.1 环境要求”">​</a></h3><ul><li>Node.js 14 及以上版本（推荐使用 16+）</li><li>TypeScript 4.0 及以上版本（如使用纯 JavaScript 也可）</li></ul><h3 id="_0-2-安装依赖" tabindex="-1">0.2 安装依赖 <a class="header-anchor" href="#_0-2-安装依赖" aria-label="Permalink to “0.2 安装依赖”">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tthsd-interface</span></span></code></pre></div><p><em><strong>tthsd-interface</strong></em> 已内置所需的 <em><strong>ffi-napi</strong></em> 和 <em><strong>ref-napi</strong></em> 依赖，并提供了完整的 TypeScript 类型定义，因此无需单独安装这些包。</p><h3 id="_0-3-动态库文件" tabindex="-1">0.3 动态库文件 <a class="header-anchor" href="#_0-3-动态库文件" aria-label="Permalink to “0.3 动态库文件”">​</a></h3><p>将 TT 高速下载器动态库放置在项目可访问的路径：</p><ul><li>Windows 平台：<em><strong>TTHSD.dll</strong></em></li><li>macOS 平台：<em><strong>TTHSD.dylib</strong></em></li><li>Linux 平台：<em><strong>TTHSD.so</strong></em></li></ul><div class="tip custom-block github-alert"><p class="custom-block-title">TIP</p><p>您可以在 <a href="https://github.com/sxxyrry/TTHSDNext/releases/latest" target="_blank" rel="noreferrer">TTHSD Next GitHub Releases</a> 页面下载最新版本的动态库文件。</p></div><hr><h2 id="_1-模块概述" tabindex="-1">1. 模块概述 <a class="header-anchor" href="#_1-模块概述" aria-label="Permalink to “1. 模块概述”">​</a></h2><ul><li><strong>核心类</strong>：<em><strong>TTHSDownloader</strong></em>（默认导出）</li><li><strong>依赖</strong>：内部使用 <em><strong>ffi-napi</strong></em>、<em><strong>ref-napi</strong></em> 调用 C 动态库，您无需直接操作它们</li><li><strong>功能</strong>： <ul><li>创建下载器实例（立即启动或只创建）</li><li>控制下载（开始、暂停、恢复、停止）</li><li>通过回调函数接收下载进度、事件通知（<em><strong>update</strong></em>、<em><strong>endOne</strong></em>、<em><strong>end</strong></em>、<em><strong>msg</strong></em>、<em><strong>err</strong></em> 等）</li><li>内置简单文件日志（调试用）</li></ul></li></ul><hr><h2 id="_2-tthsdownloader-类" tabindex="-1">2. <em><strong>TTHSDownloader</strong></em> 类 <a class="header-anchor" href="#_2-tthsdownloader-类" aria-label="Permalink to “2. TTHSDownloader 类”">​</a></h2><h3 id="_2-1-构造函数" tabindex="-1">2.1 构造函数 <a class="header-anchor" href="#_2-1-构造函数" aria-label="Permalink to “2.1 构造函数”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">constructor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dllPath</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string)</span></span></code></pre></div><ul><li><strong>参数</strong> <em><strong>dllPath</strong></em>：动态库路径（可选）。若不提供，根据操作系统自动猜测默认文件名（Windows: <em><strong>./TTHSD.dll</strong></em>，macOS: <em><strong>./TTHSD.dylib</strong></em>，Linux: <em><strong>./TTHSD.so</strong></em>），路径为当前工作目录。</li></ul><h3 id="_2-2-创建下载器" tabindex="-1">2.2 创建下载器 <a class="header-anchor" href="#_2-2-创建下载器" aria-label="Permalink to “2.2 创建下载器”">​</a></h3><h4 id="start-download-number" tabindex="-1"><em><strong>start_download(...) =&gt; number</strong></em> <a class="header-anchor" href="#start-download-number" aria-label="Permalink to “start_download(...) =&gt; number”">​</a></h4><p>立即创建并启动下载器。</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">start_download</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    urls: string[],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    savePaths: string[],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    threadCount: number </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    chunkSizeMb: number </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    callback</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserCallback,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    useCallbackUrl: boolean </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    userAgent</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    remoteCallbackUrl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    useSocket</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> boolean </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    isMultiple</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> boolean </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">): number</span></span></code></pre></div><ul><li><strong>返回</strong>：下载器实例 ID（正整数），失败时返回 -1。</li></ul><h4 id="get-downloader-number" tabindex="-1"><em><strong>get_downloader(...) =&gt; number</strong></em> <a class="header-anchor" href="#get-downloader-number" aria-label="Permalink to “get_downloader(...) =&gt; number”">​</a></h4><p>仅创建下载器（不启动），返回实例 ID。参数同 <em><strong>start_download</strong></em>（不含 <em><strong>isMultiple</strong></em>）。</p><h3 id="_2-3-控制下载" tabindex="-1">2.3 控制下载 <a class="header-anchor" href="#_2-3-控制下载" aria-label="Permalink to “2.3 控制下载”">​</a></h3><p>所有控制方法均返回 <em><strong>boolean</strong></em>，<em><strong>true</strong></em> 表示操作成功（DLL 返回 0），<em><strong>false</strong></em> 表示失败（如 ID 不存在）。</p><ul><li><em><strong>startDownloadById(downloaderId: number): boolean</strong></em>：开始顺序下载</li><li><em><strong>startMultipleDownloadsById(downloaderId: number): boolean</strong></em>：开始并行下载（实验性）</li><li><em><strong>pause_download(downloaderId: number): boolean</strong></em>：暂停下载</li><li><em><strong>resume_download(downloaderId: number): boolean</strong></em>：恢复下载</li><li><em><strong>stop_download(downloaderId: number): boolean</strong></em>：停止下载</li></ul><h3 id="_2-4-资源管理" tabindex="-1">2.4 资源管理 <a class="header-anchor" href="#_2-4-资源管理" aria-label="Permalink to “2.4 资源管理”">​</a></h3><p>接口内部会自动管理回调函数引用，防止被垃圾回收。当 <em><strong>TTHSDownloader</strong></em> 实例被销毁时，所有关联的回调引用也会被释放。<strong>无需手动调用清理方法</strong>。</p><hr><h2 id="_3-回调函数" tabindex="-1">3. 回调函数 <a class="header-anchor" href="#_3-回调函数" aria-label="Permalink to “3. 回调函数”">​</a></h2><h3 id="_3-1-定义格式" tabindex="-1">3.1 定义格式 <a class="header-anchor" href="#_3-1-定义格式" aria-label="Permalink to “3.1 定义格式”">​</a></h3><p>用户提供的回调函数需接受两个任意对象参数（实际为解析后的 JSON）：</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UserCallback</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">event</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">msg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><ul><li><strong>event</strong>：包含事件类型、名称等元数据</li><li><strong>msg</strong>：携带具体数据（进度、结果、错误等）</li></ul><h3 id="_3-2-事件类型与数据格式" tabindex="-1">3.2 事件类型与数据格式 <a class="header-anchor" href="#_3-2-事件类型与数据格式" aria-label="Permalink to “3.2 事件类型与数据格式”">​</a></h3><p>本部分与 <a href="/TTHSD/zh/event/event-overview.html">Event 文档</a> 相同，在此不过多赘述</p><h3 id="_3-3-线程安全要求" tabindex="-1">3.3 线程安全要求 <a class="header-anchor" href="#_3-3-线程安全要求" aria-label="Permalink to “3.3 线程安全要求”">​</a></h3><ul><li>回调函数在 <strong>DLL 内部的工作线程</strong> 中执行，但在 Node.js 中会被包装后进入事件循环，因此不会阻塞其他操作。</li><li><strong>禁止在回调中执行耗时操作</strong>（如磁盘写入、网络请求），也<strong>禁止直接进行可能阻塞事件循环的操作</strong>。</li><li>如果多个下载器共享同一个回调，需自行加锁保护共享数据（Node.js 是单线程，但回调可能交错，可使用原子操作或队列）。</li></ul><hr><h2 id="_4-使用示例" tabindex="-1">4. 使用示例 <a class="header-anchor" href="#_4-使用示例" aria-label="Permalink to “4. 使用示例”">​</a></h2><h3 id="_4-1-基本用法-立即启动" tabindex="-1">4.1 基本用法（立即启动） <a class="header-anchor" href="#_4-1-基本用法-立即启动" aria-label="Permalink to “4.1 基本用法（立即启动）”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { TTHSDownloader } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;tthsd-interface&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 从已安装的包导入</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> onProgress</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">event</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">msg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (event.Type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;update&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> total</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> msg.Total;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> downloaded</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> msg.Downloaded;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> taskId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> event.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ID 从 event 获取</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (total) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">***</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">进度 [\${taskId}]: \${(downloaded / total * </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).toFixed(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)}</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%***</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (event.Type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;startOne&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> url</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> msg.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">URL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> taskId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> event.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">***</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">开始下载: \${url} (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ID</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">taskId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})***);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } else if (event.Type === </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;endOne&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        const url </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> msg.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">URL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        const taskId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> event.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        console.log(***下载完成: \${url} (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ID</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">taskId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})***);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } else if (event.Type === </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;err&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        console.error(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;错误:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, msg.Error);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">const downloader </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TTHSDownloader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 自动猜测路径</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">const id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> downloader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">start_download</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;https://example.com/file1.zip&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;https://example.com/file2.zip&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;./downloads/file1.zip&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;./downloads/file2.zip&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    onProgress</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.log(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;下载已启动，ID:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, id);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_4-2-创建后手动启动-并行下载" tabindex="-1">4.2 创建后手动启动（并行下载） <a class="header-anchor" href="#_4-2-创建后手动启动-并行下载" aria-label="Permalink to “4.2 创建后手动启动（并行下载）”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { TTHSDownloader } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;tthsd-interface&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> downloader</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TTHSDownloader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;./custom/path/libTTHSD.so&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> downloader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get_downloader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;https://example.com/bigfile.iso&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;./downloads/bigfile.iso&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    10</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    downloader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">startMultipleDownloadsById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(id);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 稍后可以暂停、恢复等</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // downloader.pause_download(id);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h2 id="_5-内存管理" tabindex="-1">5. 内存管理 <a class="header-anchor" href="#_5-内存管理" aria-label="Permalink to “5. 内存管理”">​</a></h2><h3 id="_5-1-回调函数引用管理" tabindex="-1">5.1 回调函数引用管理 <a class="header-anchor" href="#_5-1-回调函数引用管理" aria-label="Permalink to “5.1 回调函数引用管理”">​</a></h3><p>每次调用 <em><strong>start_download</strong></em> 或 <em><strong>get_downloader</strong></em> 时，若提供了回调函数，会通过 <em><strong>ffi.Callback</strong></em> 创建一个 C 可调用对象。该对象必须保持存活，否则 C 代码调用时会崩溃。</p><p>TypeScript 接口通过以下方式管理这些引用：</p><ul><li>回调对象被保存在 <em><strong>callbackRefs</strong></em> Map 中，以回调对象的地址（或随机数）为键</li><li>这些引用会随着 <em><strong>TTHSDownloader</strong></em> 实例一起被垃圾回收器自动清理</li><li><strong>无需手动干预</strong>，也不需调用任何清理方法</li></ul><hr><h2 id="_6-日志系统-内部" tabindex="-1">6. 日志系统（内部） <a class="header-anchor" href="#_6-日志系统-内部" aria-label="Permalink to “6. 日志系统（内部）”">​</a></h2><p>模块内置了简单的文件日志器 <em><strong>downloaderLogger</strong></em>，日志默认：</p><ul><li>输出到控制台</li><li>写入文件 <em><strong>TTHSDPyInter.log</strong></em>（位于当前工作目录）</li><li>日志级别：<em><strong>INFO</strong></em></li></ul><p>可通过修改源码中的 <em><strong>downloaderLogger</strong></em> 配置调整（不推荐，仅供调试）。日志文件采用 <em><strong>&#39;cf&#39;</strong></em> 模式（自动创建文件）。</p><hr><h2 id="_7-注意事项" tabindex="-1">7. 注意事项 <a class="header-anchor" href="#_7-注意事项" aria-label="Permalink to “7. 注意事项”">​</a></h2><ol><li><strong>DLL 路径</strong>：若自动猜测失败，需显式传入正确路径。动态库必须与 Node.js 进程架构（32/64 位）匹配。</li><li><strong>任务数据一致性</strong>：<em><strong>urls</strong></em> 与 <em><strong>savePaths</strong></em> 长度必须相等。</li><li><strong>ID 有效性</strong>：所有控制方法（<em><strong>pause_download</strong></em> 等）在 ID 不存在时返回 <em><strong>false</strong></em>，不会抛出异常。</li><li><strong>回调异常</strong>：回调中若抛出异常，会被模块捕获并记录到日志，但不会中断下载流程。</li><li><strong>多线程环境</strong>：Node.js 是单线程事件循环，但回调可能来自不同线程，不过经过 ffi 处理后它们会被调度到事件循环中，因此无需额外加锁。但要注意不要在回调中执行同步耗时操作。</li></ol><hr><h2 id="_8-tthsd-next-的优势" tabindex="-1">8. TTHSD Next 的优势 <a class="header-anchor" href="#_8-tthsd-next-的优势" aria-label="Permalink to “8. TTHSD Next 的优势”">​</a></h2><p>相比 TTHSD Golang 版本，使用 TTHSD Next 的 TypeScript 接口可以获得以下优势：</p><h3 id="性能提升" tabindex="-1">性能提升 <a class="header-anchor" href="#性能提升" aria-label="Permalink to “性能提升”">​</a></h3><ul><li><strong>更高的下载速度</strong>：优化的异步 I/O 模型</li><li><strong>更低的内存占用</strong>：精细的内存管理，无 GC 开销</li><li><strong>更高的并发数</strong>：可支持数十万并发连接</li><li><strong>更稳定的性能</strong>：无 GC 暂停，性能可预测</li></ul><h3 id="兼容性" tabindex="-1">兼容性 <a class="header-anchor" href="#兼容性" aria-label="Permalink to “兼容性”">​</a></h3><ul><li><strong>完全兼容</strong>：API 接口与 TTHSD Golang 版本完全兼容</li><li><strong>直接替换</strong>：只需替换动态库文件即可迁移</li><li><strong>代码无需修改</strong>：现有代码可以直接使用</li></ul><hr><h2 id="_9-常见问题" tabindex="-1">9. 常见问题 <a class="header-anchor" href="#_9-常见问题" aria-label="Permalink to “9. 常见问题”">​</a></h2><p><strong>Q: 为什么我的回调没有收到 <em><strong>update</strong></em> 事件？</strong><br> A: 检查 <em><strong>callback</strong></em> 参数是否传入，且您的回调处理正常。也可通过日志观察是否有回调异常。</p><p><strong>Q: 需要手动释放资源或调用 close() 吗？</strong><br> A: 不需要。当前实现会自动管理资源，垃圾回收时会自动释放回调引用。如果希望立即释放，可以设置下载器实例为 <em><strong>null</strong></em> 并等待 GC，但通常无需这么做。</p><p><strong>Q: 需要并发下载多个任务组怎么办？</strong><br> A: 创建多个 <em><strong>TTHSDownloader</strong></em> 实例，每个管理一组任务。它们独立运行。或配合 <em><strong>worker_threads</strong></em> 模块执行多次开始下载。</p><p><strong>Q: TTHSD Next 与 TTHSD Golang 有什么区别？</strong><br> A: TTHSD Next 是 TTHSD Golang 的 Rust 重写版本，具有更高的性能、更低的内存占用和更稳定的运行表现。API 接口完全兼容，只需替换动态库即可迁移。</p><p><strong>Q: 我可以从 TTHSD Golang 迁移到 TTHSD Next 吗？</strong><br> A: 是的，API 接口完全兼容，只需将动态库文件从 TTHighSpeedDownloader.dll/so/dylib 替换为 TTHSD.dll/so/dylib 即可，代码无需修改。</p><p><strong>Q: 安装 <em><strong>tthsd-interface</strong></em> 后还需要单独安装 <em><strong>ffi-napi</strong></em> 吗？</strong><br> A: 不需要。<em><strong>tthsd-interface</strong></em> 已将其作为依赖包含，您只需安装这一个包即可。</p><hr><p>如有问题，请参考 <a href="https://github.com/sxxyrry/TTHSDNext" target="_blank" rel="noreferrer">TTHSD Next GitHub</a> 或 <a href="https://github.com/sxxyrry/tthsd-interface-ts" target="_blank" rel="noreferrer">tthsd-interface ( typescript ) 的 GitHub 主页</a>。</p>`,81)])])}const E=i(t,[["render",h]]);export{o as __pageData,E as default};
